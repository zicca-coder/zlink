# 短链接哈希冲突解决方案

## 概述

本方案设计了一个多层次的哈希冲突解决策略，确保短链接生成的唯一性和高可用性。

## 架构设计

### 1. 核心组件

- **ShortUrlGeneratorService**: 短链接生成服务接口
- **ShortUrlGeneratorServiceImpl**: 核心实现类，包含多层冲突解决策略
- **ShortUrlConfig**: 配置管理类
- **ShortUrlGenerationMetrics**: 性能监控组件
- **ShortUrlMetricsController**: 监控接口

### 2. 冲突解决策略

#### 第一层：基础生成策略
```
UUID/雪花ID → MurmurHash(32/64/128) → Base62编码 → 短链接
```

#### 第二层：冲突检测
1. **布隆过滤器快速检测**：先检查本地和Redis布隆过滤器
2. **数据库精确查询**：确认短链接是否真实存在

#### 第三层：多重重试策略
1. **第1次重试**：雪花ID
2. **第2-4次重试**：UUID + 盐值 + 重试次数
3. **第5-7次重试**：纳秒时间戳 + 随机数
4. **第8次以后**：MD5增强随机性

#### 第四层：动态长度调整
- 每3次重试失败后，短链接长度+1
- 基础长度：6位，最大长度：12位

#### 第五层：兜底策略
- 时间戳 + 随机数 + UUID的组合哈希
- 确保在极端情况下仍能生成唯一短链接

## 配置说明

```yaml
zlink:
  link:
    hashType: 32          # 哈希类型 (32/64/128)
    maxRetryTimes: 10     # 最大重试次数
    baseLength: 6         # 基础短链长度
    maxLength: 12         # 最大短链长度
```

## 性能特点

### 1. 高性能
- 布隆过滤器快速排除不存在的短链接
- 分层重试策略，避免无效的数据库查询
- 雪花算法保证高并发下的唯一性

### 2. 高可用性
- 多重兜底策略，确保在任何情况下都能生成短链接
- 动态长度调整，适应不同的冲突密度
- 完善的监控和告警机制

### 3. 可扩展性
- 支持多种哈希算法（32/64/128位）
- 可配置的重试策略和长度范围
- 插件化的冲突解决策略

## 监控指标

### 1. 核心指标
- **总生成次数**：系统总共尝试生成短链接的次数
- **成功生成次数**：成功生成唯一短链接的次数
- **成功率**：成功生成率，正常应该 > 99%
- **冲突次数**：发生哈希冲突的次数
- **冲突率**：冲突发生率，正常应该 < 1%

### 2. 性能指标
- **平均生成时间**：单次生成的平均耗时
- **平均重试次数**：平均需要重试的次数
- **最大重试次数**：历史最大重试次数
- **兜底策略使用次数**：使用最后兜底策略的次数

### 3. 健康状态评估
- **HEALTHY**：成功率 > 95%，冲突率 < 10%，平均重试 < 3次
- **WARNING**：成功率 > 95%，但冲突率 > 10% 或平均重试 > 3次
- **UNHEALTHY**：成功率 < 95%

## API接口

### 1. 获取统计信息
```http
GET /api/v1/metrics/shorturl/stats
```

### 2. 获取详细报告
```http
GET /api/v1/metrics/shorturl/report
```

### 3. 系统健康检查
```http
GET /api/v1/metrics/shorturl/health
```

### 4. 重置统计指标
```http
POST /api/v1/metrics/shorturl/reset
```

## 使用示例

```java
@Autowired
private ShortUrlGeneratorService shortUrlGeneratorService;

// 生成唯一短链接
String shortUrl = shortUrlGeneratorService.generateUniqueShortUrl(
    "https://www.example.com", 
    "group-001"
);
```

## 优化建议

### 1. 预防性措施
- 合理设置布隆过滤器的容量和误判率
- 根据业务量调整基础长度和最大长度
- 定期监控冲突率和成功率

### 2. 性能优化
- 使用分布式锁避免并发冲突
- 实现短链接预生成池
- 优化数据库查询性能

### 3. 扩展性考虑
- 支持多种编码方式（Base62/Base64等）
- 实现自定义短链接规则
- 支持短链接回收和重用

## 故障处理

### 1. 高冲突率场景
- 检查哈希算法配置
- 增加短链接基础长度
- 优化唯一性输入源

### 2. 性能下降场景
- 检查数据库连接池配置
- 优化布隆过滤器参数
- 增加缓存层

### 3. 兜底策略频繁触发
- 分析冲突原因
- 调整重试策略
- 考虑算法升级

## 总结

本方案通过多层次的冲突解决策略，确保了短链接生成的唯一性和高可用性。同时提供了完善的监控和告警机制，便于运维和优化。在实际使用中，可以根据业务特点调整相关参数，以达到最佳的性能表现。